<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bond Yield to Maturity Calculator | CFA Institute</title>
  <meta name="description" content="Interactive bond yield to maturity calculator demonstrating internal rate of return calculations">
  
  <!-- Styles -->
  <link rel="stylesheet" href="cfa-base.css">
  <link rel="stylesheet" href="bond-ytm-specific.css">
  
  <!-- MathJax for MathML rendering -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      MathML: {
        extensions: ["content-mathml.js"]
      },
      showProcessingMessages: false,
      messageStyle: "none",
      skipStartupTypeset: false,
      
      // Disable MathJax menu to prevent tabindex from being added
      showMathMenu: false,
      menuSettings: {
        zoom: "None"
      },
      
      // Process equations quickly to minimize layout shift
      "HTML-CSS": {
        scale: 100,
        minScaleAdjust: 50
      }
    });
    
    // Fix WCAG issue: aria-hidden elements should not be focusable
    // Run after MathJax finishes rendering
    MathJax.Hub.Queue(function () {
      fixAllAriaHiddenElements();
      
      // Show all rendered equations (they start hidden via CSS)
      const allMath = document.querySelectorAll('.equation-container math');
      allMath.forEach(math => {
        math.style.visibility = 'visible';
      });
    });
    
    function fixAllAriaHiddenElements() {
      // Fix 1: Remove tabindex and overflow from MathJax presentation spans and all descendants
      const presentationSpans = document.querySelectorAll('span.MathJax');
      presentationSpans.forEach(span => {
        // Remove tabindex to prevent keyboard focus issues
        span.removeAttribute('tabindex');
        // Force remove any inline overflow styles that MathJax might add
        span.style.setProperty('overflow', 'visible', 'important');
        span.style.setProperty('overflow-x', 'visible', 'important');
        span.style.setProperty('overflow-y', 'visible', 'important');
        span.style.setProperty('max-width', 'none', 'important');
        
        // Also fix all child elements that might have overflow
        const childrenWithOverflow = span.querySelectorAll('*');
        childrenWithOverflow.forEach(child => {
          child.style.setProperty('overflow', 'visible', 'important');
          child.style.setProperty('overflow-x', 'visible', 'important');
          child.style.setProperty('overflow-y', 'visible', 'important');
        });
      });
      
      // Fix 2: Remove aria-label from aria-hidden elements (not allowed)
      const ariaHiddenWithLabel = document.querySelectorAll('[aria-hidden="true"][aria-label]');
      ariaHiddenWithLabel.forEach(element => {
        element.removeAttribute('aria-label');
      });
      
      // Fix 3: All other aria-hidden elements should not be focusable
      const ariaHiddenElements = document.querySelectorAll('[aria-hidden="true"]');
      ariaHiddenElements.forEach(element => {
        // Only set tabindex if not already set to -1
        if (element.getAttribute('tabindex') !== '-1') {
          element.setAttribute('tabindex', '-1');
        }
        
        // Also fix any focusable children
        const focusableChildren = element.querySelectorAll('[tabindex="0"], a, button, input, select, textarea');
        focusableChildren.forEach(child => {
          child.setAttribute('tabindex', '-1');
        });
      });
    }
    
    // Set up MutationObserver to catch MathJax elements as they're created/modified
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length || mutation.attributeName === 'style' || mutation.attributeName === 'tabindex') {
          const mathJaxElements = document.querySelectorAll('.MathJax');
          mathJaxElements.forEach(function(el) {
            // Remove tabindex for accessibility
            el.removeAttribute('tabindex');
            
            // Fix overflow styles
            el.style.setProperty('overflow', 'visible', 'important');
            el.style.setProperty('overflow-x', 'visible', 'important');
            el.style.setProperty('overflow-y', 'visible', 'important');
            el.style.setProperty('max-width', 'none', 'important');
            
            const children = el.querySelectorAll('*');
            children.forEach(child => {
              child.style.setProperty('overflow', 'visible', 'important');
              child.style.setProperty('overflow-x', 'visible', 'important');
              child.style.setProperty('overflow-y', 'visible', 'important');
            });
          });
        }
      });
    });
    
    // Start observing the document for MathJax changes
    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['style', 'class', 'tabindex']
    });
    
    // Periodic cleanup - aggressively remove tabindex every 500ms for the first 5 seconds
    let cleanupCount = 0;
    const cleanupInterval = setInterval(function() {
      const mathJaxElements = document.querySelectorAll('.MathJax[tabindex]');
      mathJaxElements.forEach(function(el) {
        el.removeAttribute('tabindex');
      });
      
      cleanupCount++;
      if (cleanupCount >= 10) {
        clearInterval(cleanupInterval);
      }
    }, 500);
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=MML_HTMLorMML"></script>
  <script>
    // Ensure MathJax re-renders when content changes
    if (typeof MathJax !== 'undefined') {
      window.addEventListener('load', function() {
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
      });
    }
  </script>
  
  <!-- Chart.js for visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Skip Links for Accessibility -->
    <nav role="navigation" aria-label="Skip links">
      <a href="#bond-price" class="skip-link">Skip to data entry</a>
      <a href="#cash-flow-table" class="skip-link">Skip to data table</a>
    </nav>
    
    <main class="content">
      <!-- Card 0: Static Equation Derivation -->
      <section id="static-equation-card" class="card">
        <div class="equation-container" role="region" aria-label="General bond valuation formula" tabindex="0">
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
            <mrow>
              <msub>
                <mi mathcolor="#b95b1d">PV</mi>
                <mtext mathcolor="#b95b1d">Coupon bond</mtext>
              </msub>
              <mo>=</mo>
              <mfrac linethickness="1.2px">
                <mi mathcolor="#3c6ae5">PMT</mi>
                <mi mathcolor="#7a46ff">r</mi>
              </mfrac>
              <mo>×</mo>
              <mrow>
                <mo>[</mo>
                <mn>1</mn>
                <mo>−</mo>
                <mfrac linethickness="1.2px">
                  <mn>1</mn>
                  <msup>
                    <mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi mathcolor="#7a46ff">r</mi><mo>)</mo></mrow>
                    <mi mathcolor="#15803d">T</mi>
                  </msup>
                </mfrac>
                <mo>]</mo>
              </mrow>
              <mo>+</mo>
              <mfrac linethickness="1.2px">
                <mi mathcolor="#0079a6">FV</mi>
                <msup>
                  <mrow><mo>(</mo><mn>1</mn><mo>+</mo><mi mathcolor="#7a46ff">r</mi><mo>)</mo></mrow>
                  <mi mathcolor="#15803d">T</mi>
                </msup>
              </mfrac>
            </mrow>
          </math>
        </div>
        
        <p class="equation-intro" style="margin-top: 1rem;">
          Assuming that <span style="color: #3c6ae5;"><strong>PMT</strong></span> and <span style="color: #7a46ff;"><strong><i>r</i></strong></span> are annual values and that a bond pays coupons semiannually, we can modify this expression as follows:
        </p>
        
        <div class="equation-container" role="region" aria-label="Semiannual bond valuation formula" tabindex="0">
          <math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
            <mrow>
              <msub>
                <mi mathcolor="#b95b1d">PV</mi>
                <mtext mathcolor="#b95b1d">Coupon bond</mtext>
              </msub>
              <mo>=</mo>
              <mfrac linethickness="1.2px">
                <mi mathcolor="#3c6ae5">PMT</mi>
                <mi mathcolor="#7a46ff">r</mi>
              </mfrac>
              <mo>×</mo>
              <mrow>
                <mo>[</mo>
                <mn>1</mn>
                <mo>−</mo>
                <mfrac linethickness="1.2px">
                  <mn>1</mn>
                  <msup>
                    <mrow>
                      <mo>(</mo>
                      <mn>1</mn>
                      <mo>+</mo>
                      <mfrac linethickness="1.2px">
                        <mi mathcolor="#7a46ff">r</mi>
                        <mn>2</mn>
                      </mfrac>
                      <mo>)</mo>
                    </mrow>
                    <mrow><mn>2</mn><mi mathcolor="#15803d">T</mi></mrow>
                  </msup>
                </mfrac>
                <mo>]</mo>
              </mrow>
              <mo>+</mo>
              <mfrac linethickness="1.2px">
                <mi mathcolor="#0079a6">FV</mi>
                <msup>
                  <mrow>
                    <mo>(</mo>
                    <mn>1</mn>
                    <mo>+</mo>
                    <mfrac linethickness="1.2px">
                      <mi mathcolor="#7a46ff">r</mi>
                      <mn>2</mn>
                    </mfrac>
                    <mo>)</mo>
                  </mrow>
                  <mrow><mn>2</mn><mi mathcolor="#15803d">T</mi></mrow>
                </msup>
              </mfrac>
            </mrow>
          </math>
        </div>
      </section>
      
      <!-- Card 1: Dynamic Equation with Your Values -->
      <section id="equation-card" class="card">
        <h4 class="card-title">Bond Pricing Equation</h4>
        <p class="equation-intro">
          Using the semiannual bond valuation formula with your specific values:
        </p>
        
        <!-- Dynamic equation with actual values -->
        <div class="equation-container" role="region" aria-label="Bond YTM calculation with your values" aria-live="polite" id="dynamic-equation-container" tabindex="0">
          <div id="dynamic-mathml-equation">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </section>



      <!-- Card 2: Calculator -->
      <section class="card" id="calculator" tabindex="-1">
        <h4 class="card-title">Bond Yield to Maturity Calculator</h4>
        <div class="card-content">
          <!-- Static info row -->
          <div class="info-box">
            <div class="info-item">
              <span class="info-label">Face value:</span>
              <span class="info-value">USD 100.00</span>
            </div>
            <div class="info-item">
              <span class="info-label">Payment frequency:</span>
              <span class="info-value">Semiannual</span>
            </div>
          </div>

          <!-- Input controls -->
          <div class="input-section">
            <p class="sr-only" id="inputHelp">
              Enter values and the calculator updates results and the chart automatically.
            </p>

            <div class="input-group-inline">
              <div class="input-inline">
                <label for="bond-price" class="input-label-inline">
                  Bond purchase price <span style="color: #b95b1d;">(PV<sub>Coupon bond</sub>)</span>:
                </label>
                <div class="input-with-suffix-inline">
                  <span class="input-prefix-inline">USD</span>
                  <input 
                    type="number" 
                    id="bond-price" 
                    class="input-field-inline input-with-prefix"
                    min="10" max="200" step="0.1" value="97.8"
                    aria-describedby="bond-price-help">
                  <span class="sr-only" id="bond-price-help">Enter a bond purchase price between USD 10 and USD 200</span>
                </div>
              </div>

              <div class="input-inline">
                <label for="coupon-payment" class="input-label-inline">
                  Annual coupon payment <span style="color: #3c6ae5;">(C)</span>:
                </label>
                <div class="input-with-suffix-inline">
                  <span class="input-prefix-inline">USD</span>
                  <input 
                    type="number" 
                    id="coupon-payment" 
                    class="input-field-inline input-with-prefix"
                    min="0" max="30" step="0.1" value="11.0"
                    aria-describedby="coupon-payment-help">
                  <span class="sr-only" id="coupon-payment-help">Enter annual coupon payment between USD 0 and USD 30</span>
                </div>
              </div>

              <div class="input-inline">
                <label for="years" class="input-label-inline">
                  Years to maturity <span style="color: #15803d;">(T)</span>:
                </label>
                <div class="input-with-suffix-inline">
                  <input 
                    type="number" 
                    id="years" 
                    class="input-field-inline"
                    min="0.5" max="30" step="0.5" value="5"
                    aria-describedby="years-help">
                  <span class="input-suffix-inline">&nbsp;</span>
                  <span class="sr-only" id="years-help">Enter years to maturity between 0.5 and 30 years, in 0.5 year increments</span>
                </div>
              </div>
            </div>

            <!-- Validation summary -->
            <div id="validation-summary" class="validation-summary" role="alert" style="display: none;">
              <div class="validation-title">Please correct the following:</div>
              <ul id="validation-list"></ul>
            </div>
          </div>
        </div>
      </section>


      <!-- Card 3: Visualizer -->
      <section class="card" id="visualizer" tabindex="-1" style="min-height: 650px;">
        <h4 class="card-title">Bond Cash Flow and Yield Analysis</h4>
        <div class="card-content">
          <!-- View toggle buttons -->
          <div class="view-controls">
            <div class="legend" id="chart-legend" role="list" aria-label="Chart legend">
              <span class="legend-item" role="listitem">
                <span class="legend-color" style="background-color: #b95b1d;"></span>
                Bond purchase price <span style="color: #b95b1d;">(PV<sub>Coupon bond</sub>)</span>
              </span>
              <span class="legend-item" role="listitem">
                <span class="legend-color" style="background-color: #3c6ae5;"></span>
                Coupon payments <span style="color: #3c6ae5;">(C)</span>
              </span>
              <span class="legend-item" role="listitem">
                <span class="legend-color" style="background-color: #0079a6;"></span>
                Principal repayment <span style="color: #0079a6;">(FV)</span>
              </span>
              <span class="legend-item" role="listitem">
                <span class="legend-color legend-dashed-line" style="border-bottom: 2px dashed #7a46ff; background: none; width: 1.5rem; height: 0; border-left: none; border-right: none; border-top: none;"></span>
                Yield-to-maturity <span style="color: #7a46ff;">(<i>r</i>)</span>
              </span>
            </div>
            
            <div class="button-group" role="group" aria-label="View mode - switch between chart and table">
              <button id="chart-view-btn" class="toggle-btn active" aria-pressed="true">
                Chart
              </button>
              <button id="table-view-btn" class="toggle-btn" aria-pressed="false">
                Table
              </button>
            </div>
          </div>

          <!-- Screen reader announcement for view changes -->
          <div class="sr-only" aria-live="polite" aria-atomic="true" id="view-announcement"></div>

          <!-- Hidden chart description -->
          <div class="sr-only" id="ytm-chart-desc">
            <h4 id="ytm-chart-title">Bond cash flows and yield to maturity over time</h4>
            <p>
              This chart displays the complete cash flow timeline for a bond investment.
              At period 0, the bond purchase price is shown as a negative cash flow (money paid out).
              Then, at each semiannual period, the bond pays a coupon payment shown in blue.
              At the final maturity date, both the last coupon payment and the principal repayment
              (face value, shown in orange) are received. The dashed green line shows the calculated
              yield to maturity (YTM) on the right axis.
            </p>
            <p>
              Keyboard navigation: Tab to focus the chart. Use Left and Right arrow keys to move between periods.
              Press Home to jump to the first period, or End to jump to the last period.
              Each period will announce its time, YTM, coupon payment, principal repayment, and total cash flow.
            </p>
          </div>

          <!-- Chart container -->
          <div id="chart-container" class="chart-wrapper" 
               role="region" 
               aria-labelledby="ytm-chart-title" 
               aria-describedby="ytm-chart-desc"
               tabindex="-1"
               style="overflow: visible;">
            <canvas id="ytm-chart"></canvas>
          </div>

          <!-- Table container -->
          <div id="table-container" class="table-wrapper" style="display: none;"
               role="region"  
               aria-label="Bond cash flow and yield table"  
               tabindex="-1">
            <table id="cash-flow-table" class="data-table" aria-label="Bond cash flow table">
              <!-- Populated by JavaScript -->
            </table>
          </div>
        </div>
      </section>

      <section class="card" id="results-card">
        <h4 class="card-title">Results and Analysis</h4>
        <div class="card-content">
          <div id="results-content">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- JavaScript Modules -->
  <script type="module" src="bond-ytm-calculator.js"></script>
</body>
</html>